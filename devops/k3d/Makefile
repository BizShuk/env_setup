CLUSTER_NAME := dev-workspace
NAMESPACE := dev

## å¢é›†ç®¡ç† (Cluster Management)
cluster-create:    ## å»ºç«‹ k3d å¢é›†
	k3d cluster create --config k3d-config.yaml

cluster-delete:    ## åˆªé™¤ k3d å¢é›†
	k3d cluster delete $(CLUSTER_NAME)

cluster-start:     ## å•Ÿå‹• k3d å¢é›†
	k3d cluster start $(CLUSTER_NAME)

cluster-stop:      ## åœæ­¢ k3d å¢é›†
	k3d cluster stop $(CLUSTER_NAME)

cluster-list:      ## åˆ—å‡ºæ‰€æœ‰ k3d å¢é›†
	k3d cluster list

## å·¥ä½œç©ºé–“ (Workspace) â€” éœ€æŒ‡å®š PROJECT=<project_name>
setup:             ## éƒ¨ç½² workspace pod (ç”¨æ³•: make setup PROJECT=env_setup)
	@if [ -z "$(PROJECT)" ]; then echo "âŒ è«‹æŒ‡å®š PROJECT, ä¾‹å¦‚: make setup PROJECT=env_setup"; exit 1; fi
	kubectl apply -f manifests/namespace.yaml
	sed 's/PROJECT_NAME/$(PROJECT)/g' manifests/workspace-pod.yaml | kubectl apply -f -
	kubectl wait --for=condition=Ready pod/workspace-$(PROJECT) -n $(NAMESPACE) --timeout=120s
	@echo "âœ… Workspace ready! Run: make debug PROJECT=$(PROJECT)"

teardown:          ## åˆªé™¤æ‰€æœ‰è³‡æº
	kubectl delete -f manifests/namespace.yaml --ignore-not-found

## é™¤éŒ¯ (Debug) â€” éœ€æŒ‡å®š PROJECT=<project_name>
debug:             ## é€²å…¥ workspace å®¹å™¨é™¤éŒ¯ (ç”¨æ³•: make debug PROJECT=env_setup)
	@if [ -z "$(PROJECT)" ]; then echo "âŒ è«‹æŒ‡å®š PROJECT, ä¾‹å¦‚: make debug PROJECT=env_setup"; exit 1; fi
	kubectl exec -it workspace-$(PROJECT) -n $(NAMESPACE) -- bash

attach:            ## Attach åˆ° workspace å®¹å™¨
	@if [ -z "$(PROJECT)" ]; then echo "âŒ è«‹æŒ‡å®š PROJECT"; exit 1; fi
	kubectl attach -it workspace-$(PROJECT) -n $(NAMESPACE)

logs:              ## æŸ¥çœ‹ workspace logs
	@if [ -z "$(PROJECT)" ]; then echo "âŒ è«‹æŒ‡å®š PROJECT"; exit 1; fi
	kubectl logs workspace-$(PROJECT) -n $(NAMESPACE) -f

## æ–°åŠŸèƒ½å®¹å™¨ (Feature Container) â€” éœ€æŒ‡å®š PROJECT èˆ‡ NAME
feature:           ## å»ºç«‹å…¨æ–°åŠŸèƒ½å®¹å™¨ (ç”¨æ³•: make feature PROJECT=env_setup NAME=auth-v2)
	@if [ -z "$(PROJECT)" ] || [ -z "$(NAME)" ]; then echo "âŒ ç”¨æ³•: make feature PROJECT=env_setup NAME=my-feature"; exit 1; fi
	@echo "ğŸ—‘ï¸  Removing existing feature-$(NAME) if any..."
	-kubectl delete pod feature-$(NAME) -n $(NAMESPACE) --ignore-not-found --wait=true 2>/dev/null
	sed 's/FEATURE_NAME/$(NAME)/g; s/PROJECT_NAME/$(PROJECT)/g' manifests/feature-pod.yaml | kubectl apply -f -
	kubectl wait --for=condition=Ready pod/feature-$(NAME) -n $(NAMESPACE) --timeout=120s
	@echo "âœ… Brand new feature container ready! Run: make feature-debug NAME=$(NAME)"

feature-debug:     ## é€²å…¥åŠŸèƒ½å®¹å™¨é™¤éŒ¯ (ç”¨æ³•: make feature-debug NAME=my-feature)
	kubectl exec -it feature-$(NAME) -n $(NAMESPACE) -- bash

feature-delete:    ## åˆªé™¤åŠŸèƒ½å®¹å™¨ (ç”¨æ³•: make feature-delete NAME=my-feature)
	kubectl delete pod feature-$(NAME) -n $(NAMESPACE) --ignore-not-found

## ç‹€æ…‹ (Status)
status:            ## é¡¯ç¤ºæ‰€æœ‰ Pod ç‹€æ…‹
	kubectl get pods -n $(NAMESPACE) -o wide --show-labels

help:              ## é¡¯ç¤ºæ­¤èªªæ˜
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-18s\033[0m %s\n", $$1, $$2}'

.DEFAULT_GOAL := help
.PHONY: cluster-create cluster-delete cluster-start cluster-stop cluster-list setup teardown debug attach logs feature feature-debug feature-delete status help
