#!/bin/bash

# ==============================================================================
# Script Name: scan_net
# Description: 掃描指定的網絡範圍 (Scan the specified network range)
# Usage: ./scan_net.sh [range] (預設為 192.168.0.0/24)
# OS Support: macOS 與 Linux
# Dependencies: nmap
# ==============================================================================

# 顏色定義 (Color Definitions)
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# 預設範圍 (Default Range)
# 如果使用者輸入 192.168.0.0，我們預設掃描整個 /16 網域
TARGET_RANGE=${1:-"192.168.0.0/24"}

# 處理 192.168.0.0 這種寫法，自動補上 /16
if [[ "$TARGET_RANGE" == "192.168.0.0" ]]; then
    TARGET_RANGE="192.168.0.0/16"
fi

echo -e "${YELLOW}正在掃描網絡: ${TARGET_RANGE}... (Scanning network...)${NC}"

# 檢查是否安裝 nmap (Check if nmap is installed)
if ! command -v nmap &> /dev/null; then
    echo -e "${RED}錯誤: 未找到 nmap 命令。(Error: nmap not found.)${NC}"
    echo "正在嘗試使用基礎 ping 進行併發掃描 (嘗試簡單版本)..."

    # 這裡可以實作一個簡單的併發 ping 作為備案 (Simple concurrent ping fallback)
    for i in {1..254}; do
        (
            IP="192.168.0.$i"
            if ping -c 1 -W 1 "$IP" &>/dev/null; then
                echo -e "發現主機: ${GREEN}${IP}${NC}"
            fi
        ) &
    done
    wait
    exit 0
fi

echo "--------------------------------------------------"
echo -e "${BLUE}掃描模式: 高性能併發探索 (High-Performance Concurrent Scan)${NC}"
echo -e "${BLUE}並行級別 (Parallelism): 自動優化 (Auto-optimized)${NC}"
echo "--------------------------------------------------"

# 執行 nmap 掃描 (Execute nmap scan)
# -sn: Ping Scan
# -T4: Aggressive timing (速度快)
# --min-parallelism: 提高併發數量
# --max-retries 1: 減少連線重試時間
nmap -sn -T4 --min-parallelism 100 --max-retries 1 "$TARGET_RANGE" -oG - | awk '/Up$/{print $2, $3}' | while read -r ip hostname; do
    # 去除括號 (Remove parentheses from hostname)
    hostname=${hostname//[()]/}

    if [ -n "$hostname" ] && [ "$hostname" != "unknown" ]; then
        echo -e "✅ 發現主機: ${GREEN}${ip}${NC} \t名稱: ${BLUE}${hostname}${NC}"
    else
        echo -e "✅ 發現主機: ${GREEN}${ip}${NC} \t名稱: ${YELLOW}(未知/Unknown)${NC}"
    fi
done

echo "--------------------------------------------------"
echo -e "${GREEN}掃描完成。(Scan Completed.)${NC}"
