#!/bin/bash

# ==============================================================================
# Script Name: get_topo
# Description: 建立私有網絡拓撲直到連接到公網 (Build private network topology until public network)
# Usage: ./get_topo.sh
# Output: network.topo in current directory
# OS Support: macOS 與 Linux
# Dependencies: traceroute, nmap
# ==============================================================================

# 顏色定義 (Color Definitions)
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

OUTPUT_FILE="network.topo"

# 1. 判斷是否為私有 IP (Check if IP is private)
is_private() {
    local ip=$1
    if [[ $ip =~ ^10\. ]] ||
       [[ $ip =~ ^192\.168\. ]] ||
       [[ $ip =~ ^172\.(1[6-9]|2[0-9]|3[0-1])\. ]] ||
       [[ $ip =~ ^100\.(6[4-9]|[7-9][0-9]|1[0-1][0-9]|12[0-7])\. ]]; then
        return 0
    else
        return 1
    fi
}

echo -e "${YELLOW}正在分析網絡路徑... (Analyzing network path...)${NC}"

# 2. 獲取本地介面資訊 (Get local interface info)
# 找出所有活躍的私有 IP 及其網段
LOCAL_NETS=""
while read -r ip; do
    if [ -z "$ip" ]; then continue; fi
    if is_private "$ip"; then
        net=$(echo "$ip" | cut -d. -f1-3)
        # 簡單的重複檢查 (Simple duplicate check)
        if [[ ! "$LOCAL_NETS" =~ "$net" ]]; then
            LOCAL_NETS="$LOCAL_NETS $net"
        fi
    fi
done <<< "$(ifconfig | grep "inet " | grep -v 127.0.0.1 | awk '{print $2}')"

# 3. 使用 traceroute 獲取路徑並過濾私有 IP (Traceroute and extract private IPs)
echo -e "${YELLOW}正在追蹤路由... (Tracing route...)${NC}"
TR_OUTPUT=$(traceroute -n -m 20 -q 1 8.8.8.8 2>/dev/null)

# 順序存儲私有 IP 節點 (Orderly store private hops)
PRIVATE_HOPS_STR=""
while read -r line; do
    # 提取 IP (Extract IP address from line)
    ip=$(echo "$line" | grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" | head -n1)
    if [ -n "$ip" ]; then
        if is_private "$ip"; then
            PRIVATE_HOPS_STR="$PRIVATE_HOPS_STR $ip"
        else
            # 遇到第一個公網 IP 停止 (Stop at first public IP)
            break
        fi
    fi
done <<< "$(echo "$TR_OUTPUT" | awk 'NR>1')"

# 轉換為陣列 (Convert to array)
PRIVATE_HOPS=($PRIVATE_HOPS_STR)

# 4. 補全本地網絡 (Complete local network segment)
for net in $LOCAL_NETS; do
    in_path=false
    for hop in "${PRIVATE_HOPS[@]}"; do
        if [[ "$hop" == "$net".* ]]; then
            in_path=true
            break
        fi
    done
    if [ "$in_path" == "false" ]; then
        # 尋找那個網段的完整 IP (Find the full IP for that subnet)
        l_ip=$(ifconfig | grep "inet $net" | awk '{print $2}' | head -n1)
        # 將本地 IP 網段加入最前端
        PRIVATE_HOPS=("$l_ip" "${PRIVATE_HOPS[@]}")
    fi
done

# 反轉路徑：從外到內 (Reverse: Public -> Private -> Host)
REVERSED_HOPS=()
for (( i=${#PRIVATE_HOPS[@]}-1; i>=0; i-- )); do
    REVERSED_HOPS+=("${PRIVATE_HOPS[i]}")
done

echo -e "${BLUE}偵測到 ${#REVERSED_HOPS[@]} 層私有網絡。正在掃描節點...${NC}"

# 5. 掃描並產生內容 (Scan and generate content)
{
    echo "public network"

    INDENT=""
    LEVEL=1
    for hop_ip in "${REVERSED_HOPS[@]}"; do
        # 取得網段範疇
        NETWORK_PREFIX=$(echo "$hop_ip" | cut -d. -f1-3)
        echo "${INDENT}|- network $LEVEL ($NETWORK_PREFIX.0/24)"

        # 增加縮排
        INDENT="       $INDENT"

        # 掃描當前網段 (Concurrent scan)
        ALIVE_IPS=$(nmap -sn -T4 --min-parallelism 50 "$NETWORK_PREFIX.0/24" | grep "Nmap scan report for" | awk '{print $NF}' | tr -d '()')

        # 排除下一個節點節點
        NEXT_HOP_IP=""
        if [ $LEVEL -lt ${#REVERSED_HOPS[@]} ]; then
            NEXT_HOP_IP="${REVERSED_HOPS[$LEVEL]}"
        fi

        for alive_ip in $ALIVE_IPS; do
            # 排除自己 (hop_ip) 和下一跳 (NEXT_HOP_IP)
            if [ "$alive_ip" != "$hop_ip" ] && [ "$alive_ip" != "$NEXT_HOP_IP" ] && [ "$alive_ip" != "127.0.0.1" ]; then
                echo "${INDENT}|- $alive_ip"
            fi
        done

        LEVEL=$((LEVEL + 1))
    done
} > "$OUTPUT_FILE"

echo -e "--------------------------------------------------"
echo -e "${GREEN}分析完成！結果已儲存至: ${OUTPUT_FILE}${NC}"
cat "$OUTPUT_FILE"
